#!/bin/bash
# Set display refresh rate for RDP sessions
# Reduces software encoding load on VMs without hardware video encoding
# Deployed by dfe-developer ansible role

set -euo pipefail

RATE_FILE="/etc/dfe-developer/rdp-refresh-rate"

# Read configured rate or default to 30
RATE=30
if [[ -f "$RATE_FILE" ]]; then
    RATE=$(cat "$RATE_FILE" 2>/dev/null || echo 30)
fi

# Wait for display to be ready
sleep 2

# Apply to all connected outputs
for output in $(xrandr --query 2>/dev/null | grep ' connected' | awk '{print $1}'); do
    xrandr --output "$output" --rate "$RATE" 2>/dev/null || true
done
