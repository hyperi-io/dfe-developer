---
# Display refresh rate configuration for RDP performance
# Reduces software encoding load by capping refresh rate
# Only affects VMs using software RFX encoding (no VA-API H.264)

# ============================================================================
# DEPLOY REFRESH RATE SCRIPT AND AUTOSTART
# ============================================================================

- name: Deploy refresh rate script
  ansible.builtin.copy:
    src: rdp-set-refresh-rate
    dest: /usr/local/bin/rdp-set-refresh-rate
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Ensure dfe-developer config directory exists
  ansible.builtin.file:
    path: /etc/dfe-developer
    state: directory
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Write configured refresh rate
  ansible.builtin.copy:
    content: "{{ rdp_refresh_rate }}"
    dest: /etc/dfe-developer/rdp-refresh-rate
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Deploy refresh rate autostart entry
  ansible.builtin.copy:
    src: rdp-refresh-rate.desktop
    dest: /etc/xdg/autostart/rdp-refresh-rate.desktop
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Display refresh rate status
  ansible.builtin.debug:
    msg: "Display refresh rate will be capped at {{ rdp_refresh_rate }}Hz on login (reduces software encoding load)"
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
