---
# GPU Access Configuration for VirGL/virtio-gl Acceleration
# Uses udev rule to make /dev/dri/* world-readable (mode 0666).
# Any process can access the GPU without needing render/video group membership.
#
# Conditional: only runs if /dev/dri exists (GPU present).
# Works for both VirGL (VM) and physical GPUs (AMD/NVIDIA).

# ============================================================================
# DETECT GPU PRESENCE
# ============================================================================

- name: Check if /dev/dri exists (GPU present)
  ansible.builtin.stat:
    path: /dev/dri
  register: dri_device
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

# ============================================================================
# UDEV RULE FOR WORLD-READABLE GPU DEVICES
# ============================================================================

- name: Deploy udev rule for GPU device permissions
  ansible.builtin.copy:
    dest: /etc/udev/rules.d/99-gpu-open-access.rules
    mode: "0644"
    content: |
      # Allow all processes GPU access without render/video group membership
      # Managed by Ansible (dfe-developer rdp role)
      SUBSYSTEM=="drm", MODE="0666"
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
    - dri_device.stat.exists | default(false)
  notify: reload udev rules

# ============================================================================
# VERIFY GPU ACCESS
# ============================================================================

- name: Check /dev/dri/renderD128 exists
  ansible.builtin.stat:
    path: /dev/dri/renderD128
  register: render_device
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
    - dri_device.stat.exists | default(false)

- name: Display GPU configuration status
  ansible.builtin.debug:
    msg: |
      GPU access configured via udev rule (world-readable):
      - Rule: /etc/udev/rules.d/99-gpu-open-access.rules
      - /dev/dri: PRESENT
      - Render device (/dev/dri/renderD128): {{ 'PRESENT' if render_device.stat.exists | default(false) else 'NOT FOUND' }}

      All processes can access GPU devices without group membership.
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
    - dri_device.stat.exists | default(false)

- name: Display GPU skipped status
  ansible.builtin.debug:
    msg: "No GPU detected (/dev/dri not present) - skipping GPU configuration"
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
    - not (dri_device.stat.exists | default(false))
