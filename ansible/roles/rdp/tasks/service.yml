---
# Enable and configure GNOME Remote Desktop system service

# ============================================================================
# INITIALIZE SYSTEM SERVICE (required for headless/CLI setup)
# ============================================================================

- name: Initialize gnome-remote-desktop system users
  ansible.builtin.command:
    cmd: systemd-sysusers
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
  failed_when: false
  changed_when: false

- name: Initialize gnome-remote-desktop tmpfiles
  ansible.builtin.command:
    cmd: systemd-tmpfiles --create
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
  failed_when: false
  changed_when: false

# ============================================================================
# GRD PROCESS PRIORITY (reduce lag from software encoding)
# ============================================================================
# Software RFX encoding on virtio-gpu VMs is CPU-intensive. Boosting the GRD
# process priority prevents it from being starved by other workloads.

- name: Create GRD system service drop-in directory
  ansible.builtin.file:
    path: /etc/systemd/system/gnome-remote-desktop.service.d
    state: directory
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Create GRD user handover service drop-in directory
  ansible.builtin.file:
    path: /etc/systemd/user/gnome-remote-desktop-handover.service.d
    state: directory
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Deploy GRD priority override (system service)
  ansible.builtin.copy:
    src: grd-priority.conf
    dest: /etc/systemd/system/gnome-remote-desktop.service.d/priority.conf
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Deploy GRD priority override (user handover service)
  ansible.builtin.copy:
    src: grd-priority.conf
    dest: /etc/systemd/user/gnome-remote-desktop-handover.service.d/priority.conf
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

# ============================================================================
# ENABLE GNOME REMOTE DESKTOP SERVICE
# ============================================================================

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

- name: Enable gnome-remote-desktop system service
  ansible.builtin.systemd:
    name: gnome-remote-desktop.service
    enabled: true
    state: started
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

# ============================================================================
# CONFIGURE RDP VIA GRDCTL
# ============================================================================

- name: Enable RDP via grdctl
  ansible.builtin.command:
    cmd: grdctl --system rdp enable
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
  failed_when: false
  changed_when: false

- name: Disable view-only mode (allow input)
  ansible.builtin.command:
    cmd: grdctl --system rdp disable-view-only
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
  failed_when: false
  changed_when: false

# ============================================================================
# SET DEFAULT RDP CREDENTIALS
# ============================================================================

- name: Set default RDP credentials
  ansible.builtin.command:
    cmd: "grdctl --system rdp set-credentials {{ rdp_username }} {{ rdp_password }}"
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
  failed_when: false
  changed_when: false
  no_log: true  # Hide password from logs

# ============================================================================
# RESTART SERVICE TO APPLY CONFIGURATION
# ============================================================================

- name: Restart RDP service to apply configuration
  ansible.builtin.systemd:
    name: gnome-remote-desktop.service
    state: restarted
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome

# ============================================================================
# STATUS & USER INSTRUCTIONS
# ============================================================================

- name: Display RDP configuration status
  ansible.builtin.debug:
    msg: |
      GNOME Remote Desktop configured:
      - Remote Login (RDP): ENABLED on port 3389
      - Default credentials: username={{ rdp_username }}

      RDP Access:
      - Connect to: {{ ansible_hostname }}:3389 (or {{ ansible_default_ipv4.address | default('IP') }}:3389)
      - Username: {{ rdp_username }}
      - Change password: sudo grdctl --system rdp set-credentials <user> <pass>
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome
